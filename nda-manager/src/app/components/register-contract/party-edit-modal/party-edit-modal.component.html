@if (isOpen()) {
  <div class="modal-backdrop" 
       [class.modal-open]="isOpen()" 
       (click)="onClose()">
    
    <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">{{ title() }}</h3>
      <button type="button" 
              class="btn-close" 
              title="Close modal"
              (click)="onClose()"
              [disabled]="loading()">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="onSave()" #form="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Party Type *</label>
            <select
              class="form-select"
              title="Select party type"
              name="partyType"
              [ngModel]="editContact.partyType"
              (ngModelChange)="onFieldChange('partyType', $event)"
              [disabled]="loading()"
              required>
              <option value="">Select party type</option>
              <option value="disclosing">Disclosing Party</option>
              <option value="receiving">Receiving Party</option>
              <option value="witness">Witness Party</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Name *</label>
            <input
              type="text"
              class="form-input"
              placeholder="Full name"
              name="name"
              [ngModel]="editContact.name"
              (ngModelChange)="onFieldChange('name', $event)"
              [disabled]="loading()"
              required>
          </div>
          <div class="form-group">
            <label class="form-label">Entity Type *</label>
            <select
              class="form-select"
              title="Select entity type"
              name="entityType"
              [ngModel]="editContact.entityType"
              (ngModelChange)="onFieldChange('entityType', $event)"
              [disabled]="loading()"
              required>
              <option value="individual">Individual</option>
              <option value="company">Company</option>
            </select>
          </div>
        </div>

        @if (editContact.entityType === 'company') {
          <!-- Representative Information -->
          <div class="representative-section">
            <h5 class="section-subtitle">Company Representative Information</h5>
            <p class="section-description">Information of the person representing this company</p>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Representative Document Type *</label>
                <select
                  class="form-select"
                  title="Select representative document type"
                  name="representativeDocumentType"
                  [ngModel]="editContact.representativeDocument?.type || 'cpf'"
                  (ngModelChange)="onRepresentativeDocumentChange('type', $event)"
                  [disabled]="loading()"
                  required>
                  <option value="cpf">CPF</option>
                  <option value="passport">Passport</option>
                  <option value="other">Other ID</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Representative Document Number *</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="Representative's document number"
                  name="representativeDocumentNumber"
                  [ngModel]="editContact.representativeDocument?.number || ''"
                  (ngModelChange)="onRepresentativeDocumentChange('number', $event)"
                  [disabled]="loading()"
                  required>
                @if (editContact.entityType === 'company' && !editContact.representativeDocument?.number) {
                  <div class="validation-message error">
                    Representative document is required for companies
                  </div>
                }
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Company Name *</label>
              <input
                type="text"
                class="form-input"
                placeholder="Company name"
                name="companyName"
                [ngModel]="editContact.companyName"
                (ngModelChange)="onFieldChange('companyName', $event)"
                [disabled]="loading()"
                required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Company EIN *</label>
              <input
                type="text"
                class="form-input"
                placeholder="Company EIN/CNPJ"
                name="companyEIN"
                [ngModel]="editContact.companyEIN"
                (ngModelChange)="onFieldChange('companyEIN', $event)"
                [disabled]="loading()"
                required>
              @if (editContact.entityType === 'company' && (!editContact.companyEIN || !editContact.companyEIN.trim())) {
                <div class="validation-message error">
                  Company EIN is required for business entities
                </div>
              }
            </div>
          </div>

          <!-- Company Legal Document Section -->
          <div class="company-document-section">
            <h5 class="section-subtitle">Company Legal Documentation</h5>
            <p class="section-description">Legal identification documents for the company entity</p>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Company Document Type *</label>
                <select
                  class="form-select"
                  title="Select company document type"
                  name="companyDocumentType"
                  [ngModel]="editContact.identification.type"
                  (ngModelChange)="onIdentificationChange('type', $event)"
                  [disabled]="loading()"
                  required>
                  <option value="cnpj">CNPJ</option>
                  <option value="other">Other Business ID</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">Company Document Number *</label>
                <input
                  type="text"
                  class="form-input"
                  placeholder="Company CNPJ or business ID"
                  name="companyDocumentNumber"
                  [ngModel]="editContact.identification.number"
                  (ngModelChange)="onIdentificationChange('number', $event)"
                  [disabled]="loading()"
                  required>
                @if (editContact.entityType === 'company' && !editContact.identification.number) {
                  <div class="validation-message error">
                    Company legal document is required for business entities
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <div class="form-group">
          <label class="form-label">Address *</label>
          <div class="address-container">
            <div class="address-row">
              <input
                type="text"
                class="form-input"
                placeholder="Street"
                name="street"
                [ngModel]="editContact.address.street"
                (ngModelChange)="onAddressChange('street', $event)"
                [disabled]="loading()"
                required>
            </div>
            <div class="address-row two-columns">
              <input
                type="text"
                class="form-input"
                placeholder="City"
                name="city"
                [ngModel]="editContact.address.city"
                (ngModelChange)="onAddressChange('city', $event)"
                [disabled]="loading()"
                required>
              <input
                type="text"
                class="form-input"
                placeholder="State"
                name="state"
                [ngModel]="editContact.address.state"
                (ngModelChange)="onAddressChange('state', $event)"
                [disabled]="loading()"
                required>
            </div>
            <div class="address-row two-columns">
              <input
                type="text"
                class="form-input"
                placeholder="Postal Code"
                name="postalCode"
                [ngModel]="editContact.address.postalCode"
                (ngModelChange)="onAddressChange('postalCode', $event)"
                [disabled]="loading()"
                required>
              <input
                type="text"
                class="form-input"
                placeholder="Country"
                name="country"
                [ngModel]="editContact.address.country"
                (ngModelChange)="onAddressChange('country', $event)"
                [disabled]="loading()"
                required>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Official Email *</label>
          <input
            type="email"
            class="form-input"
            placeholder="official@email.com"
            name="officialEmail"
            [ngModel]="editContact.officialEmail"
            (ngModelChange)="onFieldChange('officialEmail', $event)"
            [disabled]="loading()"
            required>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" 
              class="btn-secondary" 
              (click)="onClose()"
              [disabled]="loading()">
        Cancel
      </button>
      <button type="button" 
              class="btn-primary" 
              (click)="onSave()"
              [disabled]="loading()">
        @if (loading()) {
          <span class="loading-spinner"></span>
        }
        Save Party
      </button>
    </div>
    </div>
  </div>
}